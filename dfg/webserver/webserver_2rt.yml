machines:
    - &local
      ip: 127.0.0.1
    - &dedos01
      ip: 192.168.0.2
    - &dedos02
      ip: 192.168.0.3
    - &dedos03
      ip: 192.168.0.4
    - &dedos04
      ip: 192.168.0.5
    - &db
      <<: *local
    - &gc
      <<: *dedos01
    - &rt1
      <<: *dedos02
    - &rt2
      <<: *dedos03

application:
    name: "2_runtime_webserver"

database:
    <<: *db
    port: 3306
    user: ---
    password: ---
    name: dedos

global_ctl:
    <<: *gc
    port: 8090

max_rt: &max_rt 2

msu_types:
    socket:
        id: 10
        cloneable: *max_rt
        meta_routing:
            dst_types: [read, write]
        dependencies:
            - type: read
              locality: local
            - type: write
              locality: local
        runtime_max: 1

    read:
        id: 500
        meta_routing:
            source_types: [socket, http]
            dst_types: [http]
        dependencies:
            - type: socket
              locality: local
            - type: write
              locality: local
        cloneable: *max_rt

    http:
        id: 552
        meta_routing:
            source_types: [read]
            dst_types: [write, regex, read]
        cloneable: 3

    regex:
        id: 553
        meta_routing:
            source_types: [http]
            dst_types: [write]
        cloneable: *max_rt

    write:
        id: 554
        meta_routing:
            source_types: [http, regex]
        dependencies:
            - type: read
              locality: local
            - type: socket
              locality: local
        cloneable: *max_rt
        colocation_group: 1

default: &default_rt
    port: 4444
    n_cores: 8
    n_pinned_threads: 8
    n_unpinned_threads: 3

runtimes:
    1:
        <<: *rt1
        <<: *default_rt
    2:
        <<: *rt2
        <<: *default_rt

default_msus:
    - &default_msu
      vertex_type: nop
      blocking_mode: non-blocking
      runtime: [1,2]

msus:
    - <<: *default_msu
      name: sock
      type: socket
      vertex_type: entry
      blocking_mode: blocking
      thread: 9
      init_data: "8081 500"

    - <<: *default_msu
      name: http
      type: http
      thread: 1
      init_data: "192.168.0.9 9090 1024"
      reps: 1

    - <<: *default_msu
      name: read
      type: read
      thread: 2
      reps: 4
      init_data: "ssl"

    - <<: *default_msu
      name: regex
      type: regex
      thread: 6
      reps: 2

    - <<: *default_msu
      name: write
      type: write
      vertex_type: exit
      blocking_mode: blocking
      thread: 11

routes:
    - from: [sock, http]
      to: read
      runtime-match: true

    - from: read
      to: http

    - from: http
      to: regex

    - from: [regex, http]
      to: write
